---
title: "flowPloidy: Overview"
author: "Tyler Smith"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        fig_width: 6
        fig_height: 4
    pdf_document:
        fig_width: 5
        fig_height: 4
        fig_caption: false
        pandoc_args: ["--variable=fontfamily:tgschola"]
vignette: >
  %\VignetteIndexEntry{flowPloidy: Overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: flowPloidy.bibtex
---

# Installation

`flowPloidy` depends on the Bioconductor package `flowCore`. You will have to install this dependency before we get started (this requires an internet connection):

```{r, eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite()
biocLite("flowCore")
```

You only need to do this once, not each time you use `flowPloidy`. Once `flowCore` is installed, you can install `flowPloidy`, and the remaining dependencies will automatically be installed for you. `flowPloidy` is currently available from [BitBucket](https://bitbucket.org/tws/flowPloidy), and you can install it from there using the `devtools` package (which must already be installed):


```{r, eval=FALSE}
library(devtools)
install_bitbucket("tws/flowPloidy")
```

Once the package is installed, load it as usual:

```{r}
library(flowPloidy)
```

# Preliminaries

## Sample Data Files

To get started, we need an FCS file (i.e., an LMD file as generated by the flow cytometer). For the purposes of this tutorial, we're using sample files provided with the `flowPloidy` package. These are accessed via the `system.file()` function. For regular use, you would just use the name of the files in your local directory.

## Data Channel

You will need to know which channel to use for your analysis. This will most likely remain the same for all analyses from the same flow cytometer. We can use the `read.FCS` function from the `flowCore` package to get the information we need here.

```{r, output = "hold"}
library(flowCore)
file1 <- system.file("extdata", "188-15.LMD", package = "flowPloidy")
fcs <- read.FCS(file1, alter.names = TRUE, dataset = 1)
fcs
```

The channel names are in the `name` column, which you can extract directly with:

```{r}
colnames(exprs(fcs))
```

Hopefully you see something there that corresponds to the channel you're interested in. In our case, it's "`FL3.INT.LIN`".


# Simple Analysis

With all the necessary packages installed, and the name of the channel of interest identified, we are ready to proceed with a `flowPloidy` analysis.

```{r}
fh1 <- flowHist(FILE = file1, CHANNEL = "FL3.INT.LIN")
```

Now that we have our data loaded, `plot` will display it for us:

```{r simplePlot, fig.cap = "FCS Histogram"}
plot(fh1)
```

During the loading process, `flowPloidy` attempts to locate cell populations and identify initial values for model fitting. You can see this by setting the `init = TRUE` argument in the `plot` function: 

```{r initialValues, fig.cap = "Histogram with Initial Values"}
plot(fh1, init = TRUE)
```

In this case, the initial values are close enough for the model-fitting routines to find a solution, so we can immediately proceed to the complete analysis. This will take a few moments:

```{r, cache = TRUE}
fh1 <- fhAnalyze(fh1)
```

Note that I have assigned the output of `fhAnalyze()` to the original `flowHist` object `fh1`. The output of the analysis is stored in a new slot in the `fh1` object -- all the original data remains unaltered in that object.

Now that `fh1` contains a fitted model, the results will be displayed when we call `plot` again:

```{r simpleAnalysis, fig.cap = "Histogram with Fitted Model"}
plot(fh1)
```

We can see that the coarse initial estimates were indeed close enough to give us an acceptable model fitting. The numerical results are now available by printing the `flowHist` object:

```{r, output = "hold"}
fh1
```

Here we see the ratio between the peaks with the standard error of the ratio, and a table of peak data: nuclei counts (i.e., the number of nuclei modelled in the G1 peaks), peak size, and the coefficient of variation for the peak.

## A Comment on Reduced Chi-Square Values

I have also included the Reduced Chi-Square value (RCS), recommended by @bagwell_1993 as an objective assessment of model fit. These values *should* be between 0.7 and 4.0. However, they are very sensitive to various other factors, not all strictly related to goodness of fit [@rabinovitch_1994]. In particular, I have noticed that small numbers of events detected in the higher bins (beyond the limits of the modelled peaks) can exert a disproportionate influence on RCS. Compare the previous model fit (which has a long tail of low values) to the next to see an example of this. This could be *fixed* by tweaking the way RCS is calculated, excluding regions where the fitted values are very low. At this point, I'm not sure if this is legitimate or worthwhile.

# Manually Selecting Starting Values

Sometimes, particularly with noisy histograms, `flowPloidy` will not produce useful starting values:

```{r noisyData, fig.cap = "Histogram with Bad Initial Values"}
file2 <- system.file("extdata", "337.LMD", package = "flowPloidy")
fh2 <- flowHist(FILE = file2, CHANNEL = "FL3.INT.LIN")
plot(fh2, init = TRUE)
```

Here we can see that a high spike in the debris field has confused the peak-detection algorithm. We can manually set the starting values with `pickInit`:

```{r, eval = FALSE}
fh2 <- pickInit(fh2)
```

`flowHist` will prompt you to click on the peaks of the first and second peak manually, adding a circle to the plot at each point.

```{r fakingInteraction, echo = FALSE, fig.cap = "Histogram with Manually Selected Peaks"}
## This stuff is automatically done by the interactive function pickInit,
## which we can't actually use in the automated vignette.
fh2$init <- structure(list(Ma = 169.413778820931, Sa = 8.47068894104653, 
    a1 = 5096.20000780635, Mb = 233.075681056846, Sb = 11.6537840528423, 
    b1 = 2927.36208898762, SCa = 0.1), .Names = c("Ma", "Sa", "a1", "Mb",
                                                  "Sb", "b1", "SCa"))
fh2$comps$fA2 <- NULL
fh2$model <- flowPloidy:::makeModel(fh2$comps)
plot(fh2)
points(fh2$init$Ma, 245, col = 2, cex = 3)
points(fh2$init$Mb, 95, col = 3, cex = 3)
```

The new peak values are used to recalculate the initial values:

```{r initPick, fig.cap = "Histogram with Corrected Initial Values"}
plot(fh2, init = TRUE)
```

Now we are ready for the analysis:

```{r correctedAnalysis, cache = TRUE, fig.cap = "Histogram with Fitted Model"}
fh2 <- fhAnalyze(fh2)
plot(fh2)
fh2
```

# Exporting Results

To summarize the results in a data table, use the `exportFlowHist` command:

```{r}
exportFlowHist(fh1)
```

To combine multiple objects in a single summary, combine them as a list:

```{r}
exportFlowHist(list(fh1, fh2))
```

As a convenience, if you pass a file name to the `file` argument of `exportFlowHist`, the table will be saved to that file:

```{r, eval = FALSE}
exportFlowHist(list(fh1, fh2), file = "flow-results.csv")
```

# TODO
- [ ] add linearity parameter
- [ ] convert to S4 classes for integration with flowCore and inclusion
  in BioConductor
- [ ] gating
- [ ] workflow for processing large numbers of FCS files, saving detailed
  analysis (not just summary table).

# References
