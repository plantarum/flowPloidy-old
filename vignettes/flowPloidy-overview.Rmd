---
title: "flowPloidy: Overview"
author: "Tyler Smith"
date: "`r Sys.Date()`"
output: 
    rmarkdown::html_vignette:
        fig_width: 7
        fig_height: 6
vignette: >
  %\VignetteIndexEntry{flowPloidy: Overview}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
bibliography: flowPloidy.bibtex
---

# Installation

`flowPloidy` depends on the Bioconductor package `flowCore`. You will have to install this dependency before we get started (this requires an internet connection):

```{r, eval=FALSE}
source("https://bioconductor.org/biocLite.R")
biocLite()
biocLite("flowCore")
```

You only need to do this once, not each time you use `flowPloidy`. Once `flowCore` is installed, you can install `flowPloidy`, and the remaining dependencies will automatically be installed for you. `flowPloidy` is currently available from [BitBucket](https://bitbucket.org/tws/flowPloidy), and you can install it from there using the `devtools` package (which must already be installed):


```{r, eval=FALSE}
library(devtools)
install_bitbucket("tws/flowPloidy")
```

# Preliminaries

## Sample Data Files

To get started, we need an FCS file (i.e., an LMD file as generated by the flow cytometer). For the purposes of this tutorial, we're using sample files provided with the `flowPloidy` package. These are accessed via the `system.file()` function. For regular use, you would just use the name of the files in your local directory.

## Data Channel

You will need to know which channel to use for your analysis. This will most likely remain the same for all analyses from the same flow cytometer. We can use the `read.FCS` function from the `flowCore` package to get the information we need here.

```{r, output = "hold"}
library(flowCore)
file1 <- system.file("extdata", "188-15.LMD", package = "flowPloidy")
fcs <- read.FCS(file1, alter.names = TRUE, dataset = 1)
fcs
```

The channel names are in the `name` column, which you can extract directly with:

```{r}
colnames(exprs(fcs))
```

Hopefully you see something there that corresponds to the channel you're interested in. In our case, it's "FL3.INT.LIN".


# Simple Analysis

With all the necessary packages installed, and the name of the channel of interest identified, we are ready to proceed with a `flowPloidy` analysis.

```{r}
library(flowPloidy)
fh1 <- flowHist(FILE = file1, CHANNEL = "FL3.INT.LIN")
```

To see the raw Now that we have our data loaded, `plot` will display it for us:

```{r}
plot(fh1)
```

During the loading process, `flowPloidy` attempts to locate cell populations and identify initial values for model fitting. You can see this by setting the `init = TRUE` argument in the `plot` function: 

```{r}
plot(fh1, init = TRUE)
```

In this case, the initial values are close enough for the model-fitting routines to find a solution, so we can immediately proceed to the complete analysis. This will take a few moments:

```{r, cache = TRUE}
fh1 <- fhAnalyze(fh1)
```

Note that I have assigned the output of `fhAnalyze()` to the original `flowHist` object `fh1`. The output of the analysis is stored in a new slot in the `fh1` object -- all the original data remains unaltered in that object.

Now that `fh1` contains a fitted model, the results will be displayed when we call `plot` again:

```{r}
plot(fh1)
```

We can see that the coarse initial estimates were indeed close enough to give us an acceptable model fitting. The numerical results are now available by printing the `flowHist` object:

```{r, output = "hold"}
fh1
```

Here we see the number of nuclei modelled in total, the ratio between the peaks with the standard error of the ratio, and a table of peak data: nuclei counts, peak size, and the coefficient of variation for the peak.

# Manually Selecting Starting Values

Sometimes, particularly with noisy histograms, `flowPloidy` will not produce useful starting values:

```{r}
file2 <- system.file("extdata", "337.LMD", package = "flowPloidy")
fh2 <- flowHist(FILE = file2, CHANNEL = "FL3.INT.LIN")
plot(fh2, init = TRUE)
```

Here we can see that a high spike in the debris field has confused the peak-detection algorithm. We can manually set the starting values with `pickInit`:

```{r, eval = FALSE}
fh2 <- pickInit(fh2)
```

`flowHist` will prompt you to click on the peaks of the first and second peak manually, adding a circle to the plot at each point.

```{r, echo = FALSE}
fh2$init <- structure(list(Ma = 169.413778820931, Sa = 8.47068894104653, 
    a1 = 5096.20000780635, Mb = 233.075681056846, Sb = 11.6537840528423, 
    b1 = 2927.36208898762, SCa = 0.1), .Names = c("Ma", "Sa", "a1", "Mb",
                                                  "Sb", "b1", "SCa"))
fh2$comps <- fh2$comps[sapply(fh2$comps,
                              FUN = function(x)
                                attr(x, which = "compName")) != "fA2"]
fh2$model <- makeModel(fh2$comps)
plot(fh2)
points(fh2$init$Ma, 245, col = 2, cex = 3)
points(fh2$init$Mb, 95, col = 3, cex = 3)
```

The new peak values are used to recalculate the initial values:

```{r}
plot(fh2, init = TRUE)
```

Now we are ready for the analysis:

```{r, cache = TRUE}
fh2 <- fhAnalyze(fh2)
plot(fh2)
fh2
```
This is a test citation [@bagwell_1993].

# References
